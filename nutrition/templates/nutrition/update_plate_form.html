{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Modifier {{ plate.name }} - Doc Nutrition{% endblock %}

{% block title_page %}Modifier l'assiette "{{ plate.name }}"{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-md-8">
        <form method="post">
            {% csrf_token %}
            
            <!-- Formulaire pour le nom de l'assiette -->
            <div class="mb-4">
                <h5>Informations de l'assiette</h5>
                {{ plate_form|crispy }}
            </div>
            
            <!-- Section d'ajout d'ingr√©dients -->
            <div class="mb-4">
                <h5>Ajouter un ingr√©dient</h5>
                <div class="card">
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="ingredient-search" class="form-label">Rechercher un ingr√©dient</label>
                            <!-- 
                            Attributs HTMX expliqu√©s :
                            - hx-get : Fait une requ√™te GET vers l'URL de recherche d'ingr√©dients
                            - hx-target : Injecte la r√©ponse dans l'√©l√©ment avec l'ID "search-results"
                            - hx-trigger : D√©clenche la requ√™te quand on tape (keyup) ou change la valeur (changed), avec un d√©lai de 300ms pour √©viter trop de requ√™tes
                            - hx-include : S√âLECTEURS CSS qui disent √† HTMX quels champs inclure dans la requ√™te :
                              * [name='plate_id'] = trouve l'√©l√©ment ayant name="plate_id" (le champ cach√© plus bas)
                              * [name='diet_type']:checked = trouve TOUS les √©l√©ments ayant name="diet_type" ET qui sont coch√©s
                              * HTMX cherche dans TOUTE la page, peu importe o√π sont ces √©l√©ments !
                            -->
                            <input 
                                type="text" 
                                id="ingredient-search"
                                name="q"
                                class="form-control" 
                                placeholder="Tapez le nom d'un ingr√©dient..."
                                hx-get="{% url 'nutrition:search_ingredients' %}"
                                hx-target="#search-results"
                                hx-trigger="keyup changed delay:300ms"
                                hx-include="[name='plate_id'], [name='diet_type']:checked"
                            >
                            <!-- Champ cach√© qui sera inclus dans chaque requ√™te HTMX gr√¢ce √† hx-include -->
                            <input type="hidden" name="plate_id" value="{{ plate.id }}">
                        </div>
                        
                        <!-- Nouveau : Filtres par diet_type -->
                        <div class="mb-3">
                            <label class="form-label">Filtrer par type de r√©gime</label>
                            <div class="d-flex flex-wrap gap-3">
                                <!-- 
                                Boucle Django qui g√©n√®re une checkbox pour chaque type de r√©gime :
                                - diet_type_choices vient de la vue et contient [('OMNI', 'Omnivore'), ('VEGE', 'Vegetarian'), ('VEGAN', 'Vegan')]
                                - value = code court (ex: 'OMNI'), label = nom affich√© (ex: 'Omnivore')
                                -->
                                {% for value, label in diet_type_choices %}
                                    <div class="form-check">
                                        <!-- 
                                        CHECKBOX avec attributs d√©taill√©s :
                                        
                                        üè∑Ô∏è ATTRIBUTS DE BASE :
                                        - name="diet_type" : Nom du champ c√¥t√© serveur (TOUTES les checkboxes ont le m√™me name pour √™tre group√©es)
                                        - value="{{ value }}" : Valeur envoy√©e au serveur quand coch√©e (ex: 'OMNI', 'VEGE', 'VEGAN')
                                          ‚Üí Pourquoi pas le label ? Le code court est plus facile √† traiter c√¥t√© serveur
                                        - id="diet_type_{{ value }}" : ID UNIQUE pour chaque checkbox (ex: 'diet_type_OMNI', 'diet_type_VEGE')
                                          ‚Üí N√©cessaire pour associer chaque checkbox √† son label sp√©cifique
                                        
                                        üîó ATTRIBUTS HTMX :
                                        - hx-get : URL appel√©e quand la checkbox change d'√©tat
                                        - hx-target : O√π injecter la r√©ponse (zone des r√©sultats de recherche)
                                        - hx-trigger="change" : D√©clenche la requ√™te d√®s qu'on coche/d√©coche
                                        - hx-include : OBLIGATOIRE car c'est CETTE checkbox qui d√©clenche la requ√™te !
                                          S√©lecteurs CSS pour inclure d'autres champs :
                                          * [name='plate_id'] = trouve le champ cach√© plate_id PARTOUT dans la page
                                          * [name='q'] = trouve le champ de recherche textuelle PARTOUT dans la page  
                                          * [name='diet_type']:checked = trouve TOUTES les checkboxes coch√©es PARTOUT dans la page
                                          ‚Üí HTMX scanne TOUT le DOM, peu importe o√π sont ces √©l√©ments !
                                        -->
                                        <input 
                                            class="form-check-input" 
                                            type="checkbox" 
                                            name="diet_type" 
                                            value="{{ value }}" 
                                            id="diet_type_{{ value }}"
                                            hx-get="{% url 'nutrition:search_ingredients' %}"
                                            hx-target="#search-results"
                                            hx-trigger="change"
                                            hx-include="[name='plate_id'], [name='q'], [name='diet_type']:checked"
                                        >
                                        <!-- 
                                        üè∑Ô∏è LABEL ASSOCI√â :
                                        - for="diet_type_{{ value }}" : Lie ce label √† la checkbox ayant le m√™me ID
                                        - Effet magique : cliquer sur le TEXTE coche/d√©coche automatiquement la checkbox !
                                        - Chaque checkbox a son PROPRE label (pas un seul pour toutes)
                                        - Exemple g√©n√©r√© : for="diet_type_OMNI" ‚Üí lie au id="diet_type_OMNI"
                                        -->
                                        <label class="form-check-label" for="diet_type_{{ value }}">
                                            {{ label }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Zone o√π les r√©sultats de recherche seront affich√©s -->
                        <div id="search-results"></div>
                        <!-- Div vide au d√©part - HTMX y injectera les r√©sultats de recherche -->
                    </div>
                </div>
            </div>
            
            <!-- Formset pour les ingr√©dients -->
            <div class="mb-4">
                <h5>Ingr√©dients actuels</h5>
                <div id="ingredients-formset">
                <!-- Inclut le formset des ingr√©dients qui n'est pas vide au d√©part -->
                    {% include 'nutrition/partials/ingredients_formset.html' %}
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success">Modifier</button>
                <a href="{{ plate.get_absolute_url }}" class="btn btn-secondary">Annuler</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}